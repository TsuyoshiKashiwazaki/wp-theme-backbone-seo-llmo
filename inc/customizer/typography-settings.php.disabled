<?php
/**
 * タイポグラフィ設定関連のカスタマイザー設定
 *
 * @package Kashiwazaki_SearchCraft
 */

// セキュリティ：直接アクセスを防ぐ
if (!defined('ABSPATH')) {
    exit;
}

/**
 * カスタムタイポグラフィ設定セクションを追加
 */
function seo_optimus_add_typography_settings($wp_customize) {
    // カスタムタイポグラフィ設定セクション（タイポグラフィパターン未設定時のみ表示）
    $wp_customize->add_section('seo_optimus_custom_typography', array(
        'title'    => __('カスタムタイポグラフィ設定', 'kashiwazaki-searchcraft'),
        'priority' => 32, // カスタムカラー設定の直後
        'active_callback' => function() {
            return get_theme_mod('text_pattern', 'none') === 'none';
        },
        'description' => __('JSONファイルと同等の詳細なタイポグラフィ設定を行います。既存パターンから読み込むことも可能です。', 'kashiwazaki-searchcraft'),
    ));

    // 既存JSONパターンから読み込みボタン
    $wp_customize->add_setting('custom_typography_load_pattern', array(
        'default'           => '',
        'sanitize_callback' => 'seo_optimus_sanitize_select',
    ));

    $wp_customize->add_control('custom_typography_load_pattern', array(
        'label'   => __('既存パターンから読み込み', 'kashiwazaki-searchcraft'),
        'section' => 'seo_optimus_custom_typography',
        'type'    => 'select',
        'choices' => seo_optimus_get_typography_pattern_choices(),
        'description' => __('既存のタイポグラフィパターンを読み込んでカスタマイズのベースとして使用できます。', 'kashiwazaki-searchcraft'),
    ));

    // === フォント基本設定 ===
    $wp_customize->add_setting('custom_font_family', array(
        'default'           => 'Noto Sans JP, sans-serif',
        'sanitize_callback' => 'sanitize_text_field',
    ));

    $wp_customize->add_control('custom_font_family', array(
        'label'       => __('フォントファミリー', 'kashiwazaki-searchcraft'),
        'section'     => 'seo_optimus_custom_typography',
        'type'        => 'text',
        'description' => __('使用するフォントファミリーを設定します。', 'kashiwazaki-searchcraft'),
    ));

    $wp_customize->add_setting('custom_google_fonts', array(
        'default'           => '',
        'sanitize_callback' => 'sanitize_text_field',
    ));

    $wp_customize->add_control('custom_google_fonts', array(
        'label'       => __('Googleフォント', 'kashiwazaki-searchcraft'),
        'section'     => 'seo_optimus_custom_typography',
        'type'        => 'text',
        'description' => __('Googleフォントの指定（例: Noto+Sans+JP:wght@300;400;500）', 'kashiwazaki-searchcraft'),
    ));

    // === 本文設定 ===
    $entry_content_settings = array(
        'font_size' => array('本文フォントサイズ', 'text', '1rem', array(), 'rem'),
        'line_height' => array('本文行間', 'number', '1.8', array('min' => 1.0, 'max' => 3.0, 'step' => 0.1), ''),
        'letter_spacing' => array('本文文字間隔', 'number', '0.02', array('min' => -0.1, 'max' => 0.2, 'step' => 0.001), 'em'),
        'font_weight' => array('本文フォントウェイト', 'select', '400', seo_optimus_get_font_weight_choices(), ''),
        'word_spacing' => array('本文単語間隔', 'number', '0.05', array('min' => 0, 'max' => 0.5, 'step' => 0.01), 'em'),
    );

    foreach ($entry_content_settings as $key => $config) {
        $wp_customize->add_setting("custom_entry_content_{$key}", array(
            'default'           => $config[2],
            'sanitize_callback' => ($config[1] === 'select') ? 'seo_optimus_sanitize_select' : 'seo_optimus_sanitize_number',
        ));

        $control_config = array(
            'label'       => __($config[0], 'kashiwazaki-searchcraft'),
            'section'     => 'seo_optimus_custom_typography',
            'type'        => $config[1],
            'description' => sprintf(__('%sを設定します(%s)', 'kashiwazaki-searchcraft'), $config[0], $config[4]),
        );

        if ($config[1] === 'number') {
            $control_config['input_attrs'] = $config[3];
        } else {
            $control_config['choices'] = $config[3];
        }

        $wp_customize->add_control("custom_entry_content_{$key}", $control_config);
    }

    // === H1-H6見出し設定 ===
    $heading_settings = array(
        'font_size' => array('フォントサイズ', 'text', array('2.5rem', '2rem', '1.5rem', '1.25rem', '1.1rem', '1rem'), array(), 'rem'),
        'font_weight' => array('フォントウェイト', 'select', array('700', '600', '600', '500', '500', '400'), seo_optimus_get_font_weight_choices(), ''),
        'line_height' => array('行間', 'number', array('1.2', '1.3', '1.4', '1.5', '1.6', '1.7'), array('min' => 1.0, 'max' => 3.0, 'step' => 0.1), ''),
        'letter_spacing' => array('文字間隔', 'text', array('0.01em', '0.015em', '0.02em', '0.025em', '0.03em', '0.035em'), array(), 'em'),
        'margin_top' => array('上マージン', 'text', array('3rem', '2.5rem', '2rem', '1.8rem', '1.5rem', '1.2rem'), array(), 'rem'),
        'margin_bottom' => array('下マージン', 'text', array('1.5rem', '1.2rem', '1rem', '0.8rem', '0.6rem', '0.5rem'), array(), 'rem'),
        'word_spacing' => array('単語間隔', 'text', array('0.1em', '0.08em', '0.06em', '0.04em', '0.02em', '0.01em'), array(), 'em'),
        'text_indent' => array('テキストインデント', 'text', array('0.5rem', '0.5rem', '0.5rem', '0.5rem', '0.5rem', '0.5rem'), array(), 'rem'),
    );

    for ($i = 1; $i <= 6; $i++) {
        foreach ($heading_settings as $key => $config) {
            $default_value = is_array($config[2]) ? $config[2][$i-1] : $config[2];
            
            $wp_customize->add_setting("custom_h{$i}_{$key}", array(
                'default'           => $default_value,
                'sanitize_callback' => ($config[1] === 'select') ? 'seo_optimus_sanitize_select' : (($config[1] === 'text') ? 'sanitize_text_field' : 'seo_optimus_sanitize_number'),
            ));

            $control_config = array(
                'label'       => sprintf(__('H%d %s', 'kashiwazaki-searchcraft'), $i, $config[0]),
                'section'     => 'seo_optimus_custom_typography',
                'type'        => $config[1],
                'description' => sprintf(__('H%d見出しの%sを設定します(%s)', 'kashiwazaki-searchcraft'), $i, $config[0], $config[4]),
            );

            if ($config[1] === 'number') {
                $control_config['input_attrs'] = $config[3];
            } else {
                $control_config['choices'] = $config[3];
            }

            $wp_customize->add_control("custom_h{$i}_{$key}", $control_config);
        }
    }

    // === 段落設定 ===
    $paragraph_settings = array(
        'margin_bottom' => array('段落下マージン', 'text', '1.5em', array(), 'em'),
        'text_indent' => array('段落テキストインデント', 'text', '0.5rem', array(), 'rem'),
        'word_spacing' => array('段落単語間隔', 'text', '0.02em', array(), 'em'),
    );

    foreach ($paragraph_settings as $key => $config) {
        $wp_customize->add_setting("custom_paragraphs_{$key}", array(
            'default'           => $config[2],
            'sanitize_callback' => 'sanitize_text_field',
        ));

        $wp_customize->add_control("custom_paragraphs_{$key}", array(
            'label'       => __($config[0], 'kashiwazaki-searchcraft'),
            'section'     => 'seo_optimus_custom_typography',
            'type'        => 'text',
            'description' => sprintf(__('%sを設定します(%s)', 'kashiwazaki-searchcraft'), $config[0], $config[4]),
        ));
    }

    // === リスト設定 ===
    $list_settings = array(
        'margin_bottom' => array('リスト下マージン', 'text', '1.5em', array(), 'em'),
        'margin_top' => array('リスト上マージン', 'text', '1em', array(), 'em'),
        'line_height' => array('リスト行間', 'number', '1.8', array('min' => 1.0, 'max' => 3.0, 'step' => 0.1), ''),
        'letter_spacing' => array('リスト文字間隔', 'text', '0.01em', array(), 'em'),
        'text_indent' => array('リストテキストインデント', 'text', '0.5rem', array(), 'rem'),
    );

    foreach ($list_settings as $key => $config) {
        $wp_customize->add_setting("custom_lists_{$key}", array(
            'default'           => $config[2],
            'sanitize_callback' => ($config[1] === 'text') ? 'sanitize_text_field' : 'seo_optimus_sanitize_number',
        ));

        $control_config = array(
            'label'       => __($config[0], 'kashiwazaki-searchcraft'),
            'section'     => 'seo_optimus_custom_typography',
            'type'        => $config[1],
            'description' => sprintf(__('%sを設定します(%s)', 'kashiwazaki-searchcraft'), $config[0], $config[4]),
        );

        if ($config[1] === 'number') {
            $control_config['input_attrs'] = $config[3];
        }

        $wp_customize->add_control("custom_lists_{$key}", $control_config);
    }

    // === 要素設定 ===
    $elements_config = array(
        'site_title' => 'サイトタイトル',
        'site_description' => 'サイト説明',
        'entry_meta' => 'エントリーメタ',
        'widget_title' => 'ウィジェットタイトル',
        'comments_title' => 'コメントタイトル',
        'comment_meta' => 'コメントメタ',
        'comment_reply_link' => 'コメント返信リンク',
        'wp_caption_text' => 'キャプションテキスト',
        'archive_description' => 'アーカイブ説明',
        'footer_text' => 'フッターテキスト',
        'navigation_menu' => 'ナビゲーションメニュー',
        'navigation_icon' => 'ナビゲーションアイコン',
        'button' => 'ボタン',
        'form_input' => 'フォーム入力',
        'skip_link' => 'スキップリンク',
    );

    $element_settings = array(
        'font_size' => array('フォントサイズ', 'number', array('min' => 0.5, 'max' => 3.0, 'step' => 0.1), 'rem'),
        'font_weight' => array('フォントウェイト', 'select', seo_optimus_get_font_weight_choices(), ''),
        'line_height' => array('行間', 'number', array('min' => 1.0, 'max' => 3.0, 'step' => 0.1), ''),
        'text_indent' => array('テキストインデント', 'number', array('min' => 0, 'max' => 2.0, 'step' => 0.1), 'rem'),
    );

    foreach ($elements_config as $element_key => $element_name) {
        foreach ($element_settings as $setting_key => $setting_config) {
            $wp_customize->add_setting("custom_elements_{$element_key}_{$setting_key}", array(
                'default'           => seo_optimus_get_element_default($element_key, $setting_key),
                'sanitize_callback' => ($setting_config[1] === 'select') ? 'seo_optimus_sanitize_select' : 'seo_optimus_sanitize_number',
            ));

            $control_config = array(
                'label'       => sprintf(__('%s %s', 'kashiwazaki-searchcraft'), $element_name, $setting_config[0]),
                'section'     => 'seo_optimus_custom_typography',
                'type'        => $setting_config[1],
                'description' => sprintf(__('%sの%sを設定します(%s)', 'kashiwazaki-searchcraft'), $element_name, $setting_config[0], $setting_config[3]),
            );

            if ($setting_config[1] === 'number') {
                $control_config['input_attrs'] = $setting_config[2];
            } else {
                $control_config['choices'] = $setting_config[2];
            }

            $wp_customize->add_control("custom_elements_{$element_key}_{$setting_key}", $control_config);
        }
    }
}

/**
 * フォントウェイト選択肢を取得
 */
function seo_optimus_get_font_weight_choices() {
    return array(
        '100' => '100 - Thin',
        '200' => '200 - Extra Light',
        '300' => '300 - Light',
        '400' => '400 - Normal',
        '500' => '500 - Medium',
        '600' => '600 - Semi Bold',
        '700' => '700 - Bold',
        '800' => '800 - Extra Bold',
        '900' => '900 - Black',
    );
}

/**
 * 要素のデフォルト値を取得
 */
function seo_optimus_get_element_default($element_key, $setting_key) {
    $defaults = array(
        'site_title' => array('font_size' => '1.8rem', 'font_weight' => '600', 'line_height' => '1.2', 'text_indent' => '0.5rem'),
        'site_description' => array('font_size' => '0.9rem', 'font_weight' => '400', 'line_height' => '1.4', 'text_indent' => '0.5rem'),
        'entry_meta' => array('font_size' => '0.9rem', 'font_weight' => '400', 'line_height' => '1.5', 'text_indent' => '0'),
        'widget_title' => array('font_size' => '1.3rem', 'font_weight' => '600', 'line_height' => '1.3', 'text_indent' => '0.5rem'),
        'comments_title' => array('font_size' => '1.8rem', 'font_weight' => '600', 'line_height' => '1.2', 'text_indent' => '0.5rem'),
        'comment_meta' => array('font_size' => '0.9rem', 'font_weight' => '400', 'line_height' => '1.4', 'text_indent' => '0'),
        'comment_reply_link' => array('font_size' => '0.9rem', 'font_weight' => '500', 'line_height' => '1.4', 'text_indent' => '0'),
        'wp_caption_text' => array('font_size' => '0.9rem', 'font_weight' => '400', 'line_height' => '1.4', 'text_indent' => '0'),
        'archive_description' => array('font_size' => '1rem', 'font_weight' => '400', 'line_height' => '1.8', 'text_indent' => '0.5rem'),
        'footer_text' => array('font_size' => '0.85rem', 'font_weight' => '400', 'line_height' => '1.5', 'text_indent' => '0.5rem'),
        'navigation_menu' => array('font_size' => '1rem', 'font_weight' => '500', 'line_height' => '1.4', 'text_indent' => '0'),
        'navigation_icon' => array('font_size' => '0.6rem', 'font_weight' => '400', 'line_height' => '1', 'text_indent' => '0'),
        'button' => array('font_size' => '1rem', 'font_weight' => '600', 'line_height' => '1.4', 'text_indent' => '0'),
        'form_input' => array('font_size' => '1rem', 'font_weight' => '400', 'line_height' => '1.4', 'text_indent' => '0'),
        'skip_link' => array('font_size' => '0.9rem', 'font_weight' => '600', 'line_height' => '1.3', 'text_indent' => '0'),
    );

    return isset($defaults[$element_key][$setting_key]) ? $defaults[$element_key][$setting_key] : '';
}